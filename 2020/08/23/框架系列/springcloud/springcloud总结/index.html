<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="mk-passby的博客">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        springcloud-总结 - mk-passby的博客 | mk-passby&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 我想回头望  把故事从头讲~ </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>mk-passby</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#基础选型"><span class="toc-text">基础选型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#springcloud系统基础项目实战"><span class="toc-text">springcloud系统基础项目实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务编码与构建"><span class="toc-text">微服务编码与构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#热部署"><span class="toc-text">热部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DependencyManagement"><span class="toc-text">DependencyManagement</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务注册与发现"><span class="toc-text">服务注册与发现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka基础知识"><span class="toc-text">Eureka基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务治理"><span class="toc-text">服务治理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务注册与发现-1"><span class="toc-text">服务注册与发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka两大组件"><span class="toc-text">Eureka两大组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#单机Eureka构建步骤"><span class="toc-text">单机Eureka构建步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka集群"><span class="toc-text">Eureka集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#原理说明"><span class="toc-text">原理说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#构建步骤"><span class="toc-text">构建步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务发现Discovery"><span class="toc-text">服务发现Discovery</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka自我保护"><span class="toc-text">Eureka自我保护</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zookeeper提供服务注册与发现"><span class="toc-text">zookeeper提供服务注册与发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#构建步骤-1"><span class="toc-text">构建步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consul服务注册与发现"><span class="toc-text">Consul服务注册与发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#构建步骤-2"><span class="toc-text">构建步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三个注册中心异同点"><span class="toc-text">三个注册中心异同点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CAP理论"><span class="toc-text">CAP理论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AP-Eureka"><span class="toc-text">AP(Eureka)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CP-Zookeeper-Consul"><span class="toc-text">CP(Zookeeper/Consul)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ribbon负载均衡服务调用"><span class="toc-text">Ribbon负载均衡服务调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#核心组件IRule"><span class="toc-text">核心组件IRule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义自己的轮询算法"><span class="toc-text">自定义自己的轮询算法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenFeign服务接口调用"><span class="toc-text">OpenFeign服务接口调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用步骤"><span class="toc-text">使用步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenFeign超时控制"><span class="toc-text">OpenFeign超时控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenFeign日志打印功能"><span class="toc-text">OpenFeign日志打印功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hystrix断路器"><span class="toc-text">Hystrix断路器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#服务降级构建"><span class="toc-text">服务降级构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom引入jar包"><span class="toc-text">pom引入jar包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#业务类开启服务降级"><span class="toc-text">业务类开启服务降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务调用方开启服务降级"><span class="toc-text">服务调用方开启服务降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上述配置的问题"><span class="toc-text">上述配置的问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务熔断"><span class="toc-text">服务熔断</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么配置"><span class="toc-text">怎么配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参数说明"><span class="toc-text">参数说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务监控hystrixDashboard"><span class="toc-text">服务监控hystrixDashboard</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Gateway新一代网关"><span class="toc-text">Gateway新一代网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务架构中的网关"><span class="toc-text">微服务架构中的网关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么选用springcloud-gateway"><span class="toc-text">为什么选用springcloud gateway</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spingcloudgateway的特点"><span class="toc-text">spingcloudgateway的特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路由和断言配置方式"><span class="toc-text">路由和断言配置方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在配置文件yaml中配置"><span class="toc-text">在配置文件yaml中配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码中注入RouteLocator的Bean"><span class="toc-text">代码中注入RouteLocator的Bean</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用网关做过滤"><span class="toc-text">使用网关做过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在配置文件yaml中配置i"><span class="toc-text">在配置文件yaml中配置i</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码中注入RouteLocator的Bean-1"><span class="toc-text">代码中注入RouteLocator的Bean</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义全局gatewayfilter方式"><span class="toc-text">自定义全局gatewayfilter方式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringCloud-config分布式配置中心"><span class="toc-text">SpringCloud config分布式配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#configServer的构建"><span class="toc-text">configServer的构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#configClient的构建"><span class="toc-text">configClient的构建</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringCloud-Bus-消息总线"><span class="toc-text">SpringCloud Bus 消息总线</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#构建"><span class="toc-text">构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通知总结"><span class="toc-text">通知总结</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 我想回头望  把故事从头讲~ </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        springcloud-总结
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2020-08-23 19:44:00</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#springcloud" title="springcloud">springcloud</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h1 id="基础选型"><a href="#基础选型" class="headerlink" title="基础选型"></a>基础选型</h1><h2 id="springcloud系统基础项目实战"><a href="#springcloud系统基础项目实战" class="headerlink" title="springcloud系统基础项目实战"></a>springcloud系统基础项目实战</h2><ul>
<li><a href="./SpringCloud项目搭建.md">springcloud项目搭建</a><ul>
<li>所有项目地址：<a href="https://github.com/mk-passby/springcloud2020" target="_blank" rel="noopener">点击此处</a></li>
</ul>
</li>
<li><a href="./springcloud_1.版本选型.md">springcloud_1.版本选型</a></li>
</ul>
<h2 id="微服务编码与构建"><a href="#微服务编码与构建" class="headerlink" title="微服务编码与构建"></a>微服务编码与构建</h2><h3 id="热部署"><a href="#热部署" class="headerlink" title="热部署"></a>热部署</h3><ul>
<li><p>为什么需要热部署，热部署到底是干什么的？</p>
</li>
<li><p>springboot热部署就是当一个项目在运行过程中，如果有代码修改，项目会自动重启，部署好最新的修改代码，避免人为手动重启。</p>
</li>
<li><p>​    怎么设置热部署</p>
<ul>
<li><p>新增pom依赖</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="code">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">    &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</span></span><br><span class="line">   <span class="xml"><span class="tag">&lt;<span class="name">scope</span>&gt;</span></span>runtime<span class="xml"><span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span></span><br><span class="line"><span class="code">    &lt;optional&gt;true&lt;/optional&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>新增pom插件</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="code">    &lt;plugin&gt;</span></span><br><span class="line"><span class="code">      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">      &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">      &lt;configuration&gt;</span></span><br><span class="line"><span class="code">        &lt;fork&gt;true&lt;/fork&gt;</span></span><br><span class="line"><span class="code">        &lt;addResources&gt;true&lt;/addResources&gt;</span></span><br><span class="line"><span class="code">      &lt;/configuration&gt;</span></span><br><span class="line"><span class="code">    &lt;/plugin&gt;</span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>开启自动build</p>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/1.png" alt=""></p>
</li>
<li><p>设置应用运行时自动重启，快捷键ctrl+shift+alt+/</p>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/2.png" alt=""></p>
</li>
</ul>
</li>
</ul>
<h3 id="DependencyManagement"><a href="#DependencyManagement" class="headerlink" title="DependencyManagement"></a>DependencyManagement</h3><p>在我们的分模块项目开发中通常会在父pom中看见DependencyManagement这个标签</p>
<ul>
<li>作用<ul>
<li>能让所有子项目中引用一个依赖而不用显示的列出版本号</li>
</ul>
</li>
<li>注意<ul>
<li>DependencyManagement只是声明依赖，<strong>不实现引入</strong>，需要子项目显示声明所需要的依赖</li>
<li>如果子项目中声明的依赖没有知名version和scope，都是读取自父pom</li>
<li>如果子项目中指定了版本号，那么就用子项目中自己指定的版本</li>
</ul>
</li>
</ul>
<h1 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h1><h2 id="Eureka基础知识"><a href="#Eureka基础知识" class="headerlink" title="Eureka基础知识"></a>Eureka基础知识</h2><h3 id="服务治理"><a href="#服务治理" class="headerlink" title="服务治理"></a>服务治理</h3><p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/3.bmp" alt=""></p>
<h3 id="服务注册与发现-1"><a href="#服务注册与发现-1" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h3><p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/4.bmp" alt=""><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/5.bmp" alt=""></p>
<h3 id="Eureka两大组件"><a href="#Eureka两大组件" class="headerlink" title="Eureka两大组件"></a>Eureka两大组件</h3><p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/6.bmp" alt=""></p>
<h3 id="单机Eureka构建步骤"><a href="#单机Eureka构建步骤" class="headerlink" title="单机Eureka构建步骤"></a>单机Eureka构建步骤</h3><ul>
<li><p>EurekaServer</p>
<ul>
<li>yaml文件配置</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">localhost</span>  <span class="comment">#eureka服务端的实例名字</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">false</span>    <span class="comment">#表识不向注册中心注册自己</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span>   <span class="comment">#表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span></span><br><span class="line"><span class="attr">     service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span>    <span class="comment">#设置与eureka server交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br></pre></td></tr></table></figure>
<ul>
<li>主启动类加上@EnableEurekaServer</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaMain7001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaMain7001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>pom</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="xml"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="code">        &lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-eureka-server --&gt;</span></span><br><span class="line"><span class="code">        &lt;dependency&gt;</span></span><br><span class="line"><span class="code">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">        &lt;/dependency&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>EurekaClient</p>
<ul>
<li><p>yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">![7](E:\developProject\hexo-aircloud-blog\source\_posts\框架系列\springcloud\springcloud总结\7.bmp)eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    fetchRegistry:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动类@EnableEurekaClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentMain8001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentMain8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>导pom</p>
  <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="xml"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-eureka-server --&gt;</span></span></span><br><span class="line"><span class="code">        &lt;dependency&gt;</span></span><br><span class="line"><span class="code">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">        &lt;/dependency&gt;</span></span><br><span class="line"> <span class="xml"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Eureka集群"><a href="#Eureka集群" class="headerlink" title="Eureka集群"></a>Eureka集群</h3><h4 id="原理说明"><a href="#原理说明" class="headerlink" title="原理说明"></a>原理说明</h4><p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/7.bmp" alt=""></p>
<p>解决办法：搭建Eureka注册中心集群，实现负载均衡+故障容错</p>
<h4 id="构建步骤"><a href="#构建步骤" class="headerlink" title="构建步骤"></a>构建步骤</h4><ul>
<li><p>EurekaService(7001和7002作为eureka集群)</p>
<ul>
<li>7001的yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">eureka7001.com</span>    <span class="comment">#eureka服务端的实例名字</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">false</span>    <span class="comment">#表识不向注册中心注册自己</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span>   <span class="comment">#表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://eureka7002.com:7002/eureka/</span>    <span class="comment">#设置与eureka server交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br></pre></td></tr></table></figure>
<ul>
<li>7002的yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">7002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">eureka7002.com</span> <span class="comment">#eureka服务端的实例名字</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">false</span>    <span class="comment">#表识不向注册中心注册自己</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span>   <span class="comment">#表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://eureka7001.com:7001/eureka/</span>     <span class="comment">#设置与eureka server交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其他配置类似，此处省略</li>
</ul>
</li>
<li><p>EurekaClient</p>
<ul>
<li>注册到7001和7002上，修改yaml配置</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">service-url:</span></span><br><span class="line"><span class="attr">  defaultZone:</span> <span class="attr">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span>  <span class="comment">#集群版</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其他配置类似，省略</li>
</ul>
</li>
</ul>
<h3 id="服务发现Discovery"><a href="#服务发现Discovery" class="headerlink" title="服务发现Discovery"></a>服务发现Discovery</h3><ul>
<li><p>启动类上加上@EnableDiscoveryClient</p>
</li>
<li><p>注入DiscoveryClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Eureka自我保护"><a href="#Eureka自我保护" class="headerlink" title="Eureka自我保护"></a>Eureka自我保护</h3><ul>
<li>某时刻某一个微服务不可用了，Eureka不会立刻清理，依旧会对该微服务的信息进行保存</li>
<li><p>属于CAP里面的AP分支<br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/8.bmp" alt=""><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/9.bmp" alt=""><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/10.bmp" alt=""></p>
</li>
<li><p>禁用自我保护机制</p>
<ul>
<li><p>eureakeServer端</p>
<ul>
<li>出厂默认，自我保护机制是开启的。默认配置如：eureka.server.enable-self-preservation = true，如下是关闭的配置</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  enable-self-preservation:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  eviction-interval-timer-in-ms:</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>eureakeClient端</p>
<ul>
<li>eureka.instance.lease-renewal-interval-in-seconds=30 客户端想法段发送心跳的时间间隔</li>
<li>eureka.instance.lease-expiration-duration-in-seconds=90服务端的心跳超时时间</li>
</ul>
</li>
</ul>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/11.bmp" alt=""></p>
</li>
</ul>
<h2 id="zookeeper提供服务注册与发现"><a href="#zookeeper提供服务注册与发现" class="headerlink" title="zookeeper提供服务注册与发现"></a>zookeeper提供服务注册与发现</h2><h3 id="构建步骤-1"><a href="#构建步骤-1" class="headerlink" title="构建步骤"></a>构建步骤</h3><ul>
<li><p>zookeeer搭建不走此处省略，可参考dubbo文章中安装zookeeper教程，<a href="../../中间件/dubbo/DUBBO+ZOOKEEPER入门.md">点此处跳转</a></p>
</li>
<li><p>pom</p>
</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-zookeeper-discovery --&gt;</span></span></span><br><span class="line"><span class="code">      &lt;dependency&gt;</span></span><br><span class="line"><span class="code">          &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">          &lt;artifactId&gt;spring-cloud-starter-zookeeper-discovery&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">      &lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>由于zookeeper自身就是一个服务提供者，所以不需要新建zkServcer的module了</li>
<li>消费者注册到zookeeper<ul>
<li>可能出现重启失败，zk的jar包冲突导致，spring-cloud-starter-zookeeper-discovery中的jar包和自己使用的zk版本冲突</li>
<li>服务节点是临时节点<del>还是持久节点</del></li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8004</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-provider-payment</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    zookeeper:</span></span><br><span class="line"><span class="attr">      connect-string:</span> <span class="number">192.168</span><span class="number">.11</span><span class="number">.128</span><span class="string">:2181,192.168.11.129:2181,192.168.11.130:2181</span></span><br><span class="line"><span class="attr">      base-sleep-time-ms:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>所有设置参考springcloud2020中，cloud-provider-payment8004和cloud-consumerzk-order80模块</li>
</ul>
<h2 id="Consul服务注册与发现"><a href="#Consul服务注册与发现" class="headerlink" title="Consul服务注册与发现"></a>Consul服务注册与发现</h2><ul>
<li><p>是什么</p>
<p><a href="https://www.consul.io/intro/index.html" target="_blank" rel="noopener">https://www.consul.io/intro/index.html</a><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/12.bmp" alt=""></p>
</li>
</ul>
<ul>
<li>能做什么<ul>
<li>服务发现</li>
<li>健康检查</li>
<li>KV存储</li>
<li>安全</li>
<li>加密服务通信</li>
<li>多数据中心</li>
</ul>
</li>
</ul>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/13.png" alt="1598160434397"></p>
<ul>
<li><p>怎么用</p>
<ul>
<li><p>下载安装，由于官网软件下载太慢，推荐使用springcloud2020中soft中，我已下载好的，直接安装</p>
</li>
<li><p>双击运行，或使用开发模式启动(</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问Consul的首页：http;//localhost:8500</p>
</li>
</ul>
</li>
</ul>
<h3 id="构建步骤-2"><a href="#构建步骤-2" class="headerlink" title="构建步骤"></a>构建步骤</h3><p>  Consul的构建和zk类似</p>
<ul>
<li>改pom，引入jar包</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="code">     &lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-consul-discovery --&gt;</span></span><br><span class="line"><span class="code">     &lt;dependency&gt;</span></span><br><span class="line"><span class="code">         &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">         &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">     &lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>同样自己就是一个注册中心应用，自己就是server</li>
<li>服务注册者注册consul，改yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8006</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">consul-provider-payment</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    consul:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">8500</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="三个注册中心异同点"><a href="#三个注册中心异同点" class="headerlink" title="三个注册中心异同点"></a>三个注册中心异同点</h2><h3 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h3><p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/14.bmp" alt=""><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/15.bmp" alt=""></p>
<h3 id="AP-Eureka"><a href="#AP-Eureka" class="headerlink" title="AP(Eureka)"></a>AP(Eureka)</h3><p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/16.bmp" alt=""></p>
<h3 id="CP-Zookeeper-Consul"><a href="#CP-Zookeeper-Consul" class="headerlink" title="CP(Zookeeper/Consul)"></a>CP(Zookeeper/Consul)</h3><p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/17.bmp" alt=""></p>
<h1 id="Ribbon负载均衡服务调用"><a href="#Ribbon负载均衡服务调用" class="headerlink" title="Ribbon负载均衡服务调用"></a>Ribbon负载均衡服务调用</h1><ul>
<li>是什么</li>
</ul>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/18.bmp" alt=""></p>
<ul>
<li>官网：<a href="https://github.com/Netflix/ribbon/wiki/Getting-Started" target="_blank" rel="noopener">https://github.com/Netflix/ribbon/wiki/Getting-Started</a></li>
<li>类别<ul>
<li>集中式LB<ul>
<li>在消费方和提供方之间使用独立的LB设施，将访问请求通过某种策略传给消费方(F5,NGNIX)</li>
</ul>
</li>
<li>进程内LB<ul>
<li>将LB逻辑集成到消费方，消费方从服务注册中心获取哪些地址可用，然后自己选择一个合适的服务器(Ribbon)</li>
</ul>
</li>
</ul>
</li>
<li>架构说明<br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/19.bmp" alt=""><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/20.bmp" alt=""></li>
<li><p>ribbon的使用</p>
<ul>
<li>ribbon的使用相对很简单，因为eureka已经集成了ribbon，所以不需要我们再导包</li>
<li>负载均衡+RestTemplate调用</li>
</ul>
</li>
</ul>
<h3 id="核心组件IRule"><a href="#核心组件IRule" class="headerlink" title="核心组件IRule"></a>核心组件IRule</h3><p>IRule:根据特定算法从服务列表中选取一个要访问的服务</p>
<table>
<thead>
<tr>
<th>实现类</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>com.netflix.loadbalancer.RoundRobinRule</td>
<td>轮询</td>
</tr>
<tr>
<td>com.netflix.loadbalancer.RandomRule</td>
<td>随机</td>
</tr>
<tr>
<td>com.netflix.loadbalancer.RetryRule</td>
<td>先按照RoundRobinRule的策略获取服务，如果获取服务失败则在指定时间内会进行重试</td>
</tr>
<tr>
<td>WeightedResponseTimeRule</td>
<td>对RoundRobinRule的扩展，响应速度越快的实例选择权重越大，越容易被选择</td>
</tr>
<tr>
<td>BestAvailableRule</td>
<td>会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务</td>
</tr>
<tr>
<td>AvailabilityFilteringRule</td>
<td>先过滤掉故障实例，再选择并发较小的实例</td>
</tr>
<tr>
<td>ZoneAvoidanceRule</td>
<td>默认规则，复合判断server所在区域的性能和server的可用性选择服务器</td>
</tr>
</tbody>
</table>
<h3 id="自定义自己的轮询算法"><a href="#自定义自己的轮询算法" class="headerlink" title="自定义自己的轮询算法"></a>自定义自己的轮询算法</h3><p>参见文章，<a href="Ribbon详解.md">Ribbon详解</a></p>
<h1 id="OpenFeign服务接口调用"><a href="#OpenFeign服务接口调用" class="headerlink" title="OpenFeign服务接口调用"></a>OpenFeign服务接口调用</h1><ul>
<li>是什么</li>
</ul>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/21.bmp" alt=""><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/22.bmp" alt=""></p>
<ul>
<li>官网：<a href="https://github.com/spring-cloud/spring-cloud-openfeign" target="_blank" rel="noopener">https://github.com/spring-cloud/spring-cloud-openfeign</a></li>
<li>有什么用</li>
</ul>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/23.bmp" alt=""></p>
<h2 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h2><ul>
<li>改pom</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="code">       &lt;dependency&gt;</span></span><br><span class="line"><span class="code">           &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">           &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">       &lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>主启动类@EnableFeignClients</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bli.guigu.springcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: springcloud2020</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: feign启动类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mk_passby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-08-02 15:55</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFeignMain80</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderFeignMain80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>业务类，在接口配置@FeignClient</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.bli.guigu.springcloud.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.bli.guigu.springcloud.entities.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.bli.guigu.springcloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: springcloud2020</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mk_passby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-08-02 15:59</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"CLOUD-PAYMENT-SERVICE"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentFeignService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"payment/get/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">getPayment</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/payment/feign/timeout"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentFeignTimeout</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="OpenFeign超时控制"><a href="#OpenFeign超时控制" class="headerlink" title="OpenFeign超时控制"></a>OpenFeign超时控制</h2><p>OpenFeign接口调用默认等待一秒钟，超过后报错</p>
<ul>
<li>YML文件里需要开启OpenFeign客户端超时控制</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line"><span class="attr">  ReadTimeout:</span>  <span class="number">5000</span></span><br><span class="line"><span class="attr">  ConnectTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>
<h2 id="OpenFeign日志打印功能"><a href="#OpenFeign日志打印功能" class="headerlink" title="OpenFeign日志打印功能"></a>OpenFeign日志打印功能</h2><p>Feign提供了日志打印功能，我们可以通过配置日志的级别来了解到Feign中http请求的细节。(接口调用情况的监控)</p>
<ul>
<li>配置一个日志级别的bean</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bli.guigu.springcloud.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: springcloud2020</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mk_passby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-08-02 16:23</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>YML文件里需要开启日志的Feign客户端</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">com.bli.guigu.springcloud.service.PaymentFeignService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>
<h1 id="Hystrix断路器"><a href="#Hystrix断路器" class="headerlink" title="Hystrix断路器"></a>Hystrix断路器</h1><ul>
<li><p>是什么<br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/24.bmp" alt=""></p>
</li>
<li><p>作用：</p>
<ul>
<li>服务降级：服务器忙，请稍候再试，不让客户端等待并立刻返回一个友好提示，fallback</li>
<li>服务熔断：直接拒绝访问</li>
<li>接近实时的监控</li>
</ul>
</li>
<li><p>官网：<a href="https://github.com/Netflix/Hystrix/wiki/How-To-Use" target="_blank" rel="noopener">https://github.com/Netflix/Hystrix/wiki/How-To-Use</a></p>
</li>
</ul>
<h2 id="服务降级构建"><a href="#服务降级构建" class="headerlink" title="服务降级构建"></a>服务降级构建</h2><h3 id="pom引入jar包"><a href="#pom引入jar包" class="headerlink" title="pom引入jar包"></a>pom引入jar包</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!--新增hystrix--&gt;</span></span></span><br><span class="line"><span class="code">     &lt;dependency&gt;</span></span><br><span class="line"><span class="code">         &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">         &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">     &lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="业务类开启服务降级"><a href="#业务类开启服务降级" class="headerlink" title="业务类开启服务降级"></a>业务类开启服务降级</h3><ul>
<li>@HystrixCommand报异常后如何处理</li>
<li>主启动类添加注解@EnableCircuitBreaker</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bli.guigu.springcloud.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;</span><br><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.Meter.Id;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: springcloud2020</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: service</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mk_passby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-08-02 16:46</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_OK</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"线程池："</span> + Thread.currentThread().getName() + <span class="string">",paymentInfo_OK ,id:"</span> + id</span><br><span class="line">            + <span class="string">"----------"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"paymentInfo_TimeOutHandler"</span>, commandProperties = &#123;</span><br><span class="line">        <span class="meta">@HystrixProperty</span>(name = <span class="string">"execution.isolation.thread.timeoutInMilliseconds"</span>, value = <span class="string">"5000"</span>)&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TimeOut</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(id);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"线程池："</span> + Thread.currentThread().getName() + <span class="string">"   paymentInfo_TimeOut,id：  "</span> + id</span><br><span class="line">            + <span class="string">"\t"</span> + <span class="string">"呜呜呜"</span> + <span class="string">" 耗时(秒)"</span> + id;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TimeOutHandler</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"线程池："</span> + Thread.currentThread().getName() + <span class="string">"  Error or timeout,id：  "</span> + id</span><br><span class="line">            + <span class="string">"\t"</span> + <span class="string">"QAQ"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//服务熔断</span></span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"paymentCircuitBreaker_fallback"</span>,commandProperties = &#123;</span><br><span class="line">        <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.enabled"</span>,value = <span class="string">"true"</span>),  <span class="comment">//是否开启断路器</span></span><br><span class="line">        <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.requestVolumeThreshold"</span>,value = <span class="string">"10"</span>),   <span class="comment">//请求次数</span></span><br><span class="line">        <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.sleepWindowInMilliseconds"</span>,value = <span class="string">"10000"</span>),  <span class="comment">//时间范围</span></span><br><span class="line">        <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.errorThresholdPercentage"</span>,value = <span class="string">"60"</span>), <span class="comment">//失败率达到多少后跳闸</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentCircuitBreaker</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (id &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"*****id 不能负数"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String serialNumber = IdUtil.simpleUUID();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Thread.currentThread().getName()+<span class="string">"\t"</span>+<span class="string">"调用成功,流水号："</span>+serialNumber;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentCircuitBreaker_fallback</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"id 不能负数，请稍候再试,(┬＿┬)/~~     id: "</span> +id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bli.guigu.springcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.metrics.eventstream.HystrixMetricsStreamServlet;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.ServletRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: springcloud2020</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mk_passby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-08-02 16:45</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentHystrixMain8001</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentHystrixMain8001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此配置是为了服务监控而配置，与服务容错本身无关，springcloud升级后的坑</span></span><br><span class="line"><span class="comment">     * servletRegistrationBean因为springBoot的默认路径不是"/hystrix.stream"</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">getServlet</span><span class="params">()</span></span>&#123;</span><br><span class="line">        HystrixMetricsStreamServlet streamServlet = <span class="keyword">new</span> HystrixMetricsStreamServlet();</span><br><span class="line">        ServletRegistrationBean registrationBean = <span class="keyword">new</span> ServletRegistrationBean(streamServlet);</span><br><span class="line">        registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        registrationBean.addUrlMappings(<span class="string">"/hystrix.stream"</span>);</span><br><span class="line">        registrationBean.setName(<span class="string">"HystrixMetricsStreamServlet"</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="服务调用方开启服务降级"><a href="#服务调用方开启服务降级" class="headerlink" title="服务调用方开启服务降级"></a>服务调用方开启服务降级</h3><ul>
<li>yaml配置</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line"><span class="attr">  hystrix:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span> <span class="comment">#如果处理自身的容错就开启。开启方式与生产端不一样</span></span><br></pre></td></tr></table></figure>
<ul>
<li>主启动开启@EnableHystrix</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bli.guigu.springcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.hystrix.EnableHystrix;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: springcloud2020</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mk_passby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-08-02 17:25</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableHystrix</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderHystrixMain80</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderHystrixMain80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>业务类自己再设置兜底</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/consumer/payment/hystrix/timeout/&#123;id&#125;"</span>)</span><br><span class="line">  <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"paymentTimeOutFallbackMethod"</span>,</span><br><span class="line">      commandProperties = &#123;</span><br><span class="line">          <span class="meta">@HystrixProperty</span>(</span><br><span class="line">              name = <span class="string">"execution.isolation.thread.timeoutInMilliseconds"</span>,</span><br><span class="line">              value = <span class="string">"4000"</span>) <span class="comment">//1.5秒钟以内就是正常的业务逻辑</span></span><br><span class="line">      &#125;)</span><br><span class="line">  <span class="comment">//@HystrixCommand</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TimeOut</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">      String result = paymentHystrixService.paymentInfo_TimeOut(id);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//兜底方法</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">paymentTimeOutFallbackMethod</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"我是消费者80，对付支付系统繁忙请10秒钟后再试或者自己运行出错请检查自己,(┬＿┬)"</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="上述配置的问题"><a href="#上述配置的问题" class="headerlink" title="上述配置的问题"></a>上述配置的问题</h3><p>每个方法配置一个兜底方法，过于膨胀</p>
<ul>
<li>@DefaultProperties(defaultFallback = “”)</li>
</ul>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/25.bmp" alt=""></p>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/26.png" alt=""></p>
<h2 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h2><ul>
<li>是什么</li>
</ul>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/27.bmp" alt=""></p>
<h3 id="怎么配置"><a href="#怎么配置" class="headerlink" title="怎么配置"></a>怎么配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务熔断</span></span><br><span class="line">   <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"paymentCircuitBreaker_fallback"</span>,commandProperties = &#123;</span><br><span class="line">       <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.enabled"</span>,value = <span class="string">"true"</span>),  <span class="comment">//是否开启断路器</span></span><br><span class="line">       <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.requestVolumeThreshold"</span>,value = <span class="string">"10"</span>),   <span class="comment">//请求次数</span></span><br><span class="line">       <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.sleepWindowInMilliseconds"</span>,value = <span class="string">"10000"</span>),  <span class="comment">//时间范围</span></span><br><span class="line">       <span class="meta">@HystrixProperty</span>(name = <span class="string">"circuitBreaker.errorThresholdPercentage"</span>,value = <span class="string">"60"</span>), <span class="comment">//失败率达到多少后跳闸</span></span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">paymentCircuitBreaker</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id)</span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (id &lt; <span class="number">0</span>)&#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"*****id 不能负数"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       String serialNumber = IdUtil.simpleUUID();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> Thread.currentThread().getName()+<span class="string">"\t"</span>+<span class="string">"调用成功,流水号："</span>+serialNumber;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/28.bmp" alt=""></p>
<h2 id="服务监控hystrixDashboard"><a href="#服务监控hystrixDashboard" class="headerlink" title="服务监控hystrixDashboard"></a>服务监控hystrixDashboard</h2><ul>
<li>见springcloud2020下的cloud-consumer-hystrix-dashboard9001</li>
</ul>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/29.bmp" alt=""><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/30.bmp" alt=""><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/31.bmp" alt=""></p>
<h1 id="Gateway新一代网关"><a href="#Gateway新一代网关" class="headerlink" title="Gateway新一代网关"></a>Gateway新一代网关</h1><ul>
<li>官网：<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/" target="_blank" rel="noopener">https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/</a></li>
<li>是什么<ul>
<li>Spring Cloud Gateway 使用的Webflux中的reactor-netty响应式编程组件，底层使用了Netty通讯框架<br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/32.bmp" alt=""><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/33.bmp" alt=""><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/34.bmp" alt=""></li>
</ul>
</li>
<li>作用<ul>
<li>反向代理</li>
<li>鉴权</li>
<li>流控</li>
<li>熔断</li>
<li>日志监控</li>
</ul>
</li>
</ul>
<h2 id="微服务架构中的网关"><a href="#微服务架构中的网关" class="headerlink" title="微服务架构中的网关"></a>微服务架构中的网关</h2><p> <img src="/2020/08/23/框架系列/springcloud/springcloud总结/35.bmp" alt=""></p>
<h2 id="为什么选用springcloud-gateway"><a href="#为什么选用springcloud-gateway" class="headerlink" title="为什么选用springcloud gateway"></a>为什么选用springcloud gateway</h2><ul>
<li>neflix不太靠谱，zuul2.0一直跳票,迟迟不发布</li>
<li>SpringCloud Gateway与Zuul的区别<br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/36.bmp" alt=""></li>
</ul>
<h2 id="spingcloudgateway的特点"><a href="#spingcloudgateway的特点" class="headerlink" title="spingcloudgateway的特点"></a>spingcloudgateway的特点</h2><p> <img src="/2020/08/23/框架系列/springcloud/springcloud总结/37.bmp" alt=""></p>
<ul>
<li>Route路由<ul>
<li>路由是构建网关的基本模块，它由ID，目标URI，一系列的断言和过滤器组成，如果断言为true则匹配该路由</li>
</ul>
</li>
<li>Predicate断言<ul>
<li>参考的是java8的java.util.function.Predicate开发人员可以匹配HTTP请求中的所有内容（例如请求头或请求参数），如果请求与断言相匹配则进行路由</li>
</ul>
</li>
<li>Filter(过滤)<ul>
<li>指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前或者之后对请求进行修改。</li>
</ul>
</li>
</ul>
<p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/38.bmp" alt=""></p>
<h2 id="路由和断言配置方式"><a href="#路由和断言配置方式" class="headerlink" title="路由和断言配置方式"></a>路由和断言配置方式</h2><h3 id="在配置文件yaml中配置"><a href="#在配置文件yaml中配置" class="headerlink" title="在配置文件yaml中配置"></a>在配置文件yaml中配置</h3><ul>
<li>pom</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="code">     &lt;!--新增gateway--&gt;</span></span><br><span class="line"><span class="code">     &lt;dependency&gt;</span></span><br><span class="line"><span class="code">         &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">         &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">     &lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>改yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9527</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-gateway</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">        - id:</span> <span class="string">payment_routh</span> <span class="comment">#路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">http://localhost:8001</span>   <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line"><span class="attr">          predicates:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">Path=/payment/get/**</span>   <span class="comment">#断言,路径相匹配的进行路由</span></span><br><span class="line"></span><br><span class="line"><span class="attr">        - id:</span> <span class="string">payment_routh2</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">http://localhost:8001</span></span><br><span class="line"><span class="attr">          predicates:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">Path=/payment/lb/**</span>   <span class="comment">#断言,路径相匹配的进行路由</span></span><br><span class="line">            <span class="comment">#- After=2020-03-08T10:59:34.102+08:00[Asia/Shanghai]</span></span><br><span class="line">            <span class="comment">#- Cookie=username,zhangshuai #并且Cookie是username=zhangshuai才能访问</span></span><br><span class="line">            <span class="comment">#- Header=X-Request-Id, \d+ #请求头中要有X-Request-Id属性并且值为整数的正则表达式</span></span><br><span class="line">            <span class="comment">#- Host=**.atguigu.com</span></span><br><span class="line">            <span class="comment">#- Method=GET</span></span><br><span class="line">            <span class="comment">#- Query=username, \d+ #要有参数名称并且是正整数才能路由</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      fetch-registry:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>
<h3 id="代码中注入RouteLocator的Bean"><a href="#代码中注入RouteLocator的Bean" class="headerlink" title="代码中注入RouteLocator的Bean"></a>代码中注入RouteLocator的Bean</h3><ul>
<li>配置类如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bli.guigu.springcloud.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: springcloud2020</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:文档路径：https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mk_passby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-08-03 23:01</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//http://news.baidu.com/guoji</span></span><br><span class="line">        <span class="keyword">return</span> builder.routes()</span><br><span class="line">            .route(<span class="string">"path_route_bliguigu"</span>,</span><br><span class="line">                r -&gt; r.path(<span class="string">"/guonei"</span>).uri(<span class="string">"http://news.baidu.com/guonei"</span>)).build();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用网关做过滤"><a href="#使用网关做过滤" class="headerlink" title="使用网关做过滤"></a>使用网关做过滤</h2><h3 id="在配置文件yaml中配置i"><a href="#在配置文件yaml中配置i" class="headerlink" title="在配置文件yaml中配置i"></a>在配置文件yaml中配置i</h3><ul>
<li><p>这里就取一个springcloudGateway的官网的例子吧，Example 13. application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span></span><br><span class="line"><span class="attr">      - id:</span> <span class="string">add_request_header_route</span></span><br><span class="line"><span class="attr">        uri:</span> <span class="attr">https://example.org</span></span><br><span class="line"><span class="attr">        filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">AddRequestHeader=X-Request-red,</span> <span class="string">blue</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">AddRequestParameter=red,</span> <span class="string">blue</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意这里的过滤是指可以修改传入或传出的HTTP请求响应。</li>
<li>如上 - AddRequestHeader=X-Request-red, blue表示给所有匹配的请求头中添加了 X-Request-red: blue</li>
<li>AddRequestParameter=red, blue表示给所有匹配的请求添加查询字符串<code>red=blue</code>，比如我的请求是localhost/getUser，实际传过去的就是多传了一个red=blue的传参过去，类似get请求的localhost/getUser?red=blue</li>
</ul>
</li>
</ul>
<h3 id="代码中注入RouteLocator的Bean-1"><a href="#代码中注入RouteLocator的Bean-1" class="headerlink" title="代码中注入RouteLocator的Bean"></a>代码中注入RouteLocator的Bean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.bli.guigu.springcloud.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: springcloud2020</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:文档路径：https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.1.RELEASE/reference/html/</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mk_passby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-08-03 23:01</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//http://news.baidu.com/guoji</span></span><br><span class="line">        <span class="keyword">return</span> builder.routes()</span><br><span class="line">            .route(<span class="string">"path_route_bliguigu"</span>,</span><br><span class="line">                r -&gt; r.path(<span class="string">"/guonei"</span>)</span><br><span class="line">                    .filters(f -&gt; f.addRequestHeader(<span class="string">"X-Request-red"</span>, <span class="string">"blue"</span>))</span><br><span class="line">                    .uri(<span class="string">"http://news.baidu.com/guonei"</span>)).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自定义全局gatewayfilter方式"><a href="#自定义全局gatewayfilter方式" class="headerlink" title="自定义全局gatewayfilter方式"></a>自定义全局gatewayfilter方式</h2><ul>
<li>官网描述如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">6.1</span>. Combined Global Filter and GatewayFilter Ordering</span><br><span class="line">When a request matches a route, the filtering web handler adds all instances of GlobalFilter and all route-specific instances of GatewayFilter to a filter chain. This combined filter chain is sorted by the org.springframework.core.Ordered <span class="class"><span class="keyword">interface</span>, <span class="title">which</span> <span class="title">you</span> <span class="title">can</span> <span class="title">set</span> <span class="title">by</span> <span class="title">implementing</span> <span class="title">the</span> <span class="title">getOrder</span>() <span class="title">method</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">As</span> <span class="title">Spring</span> <span class="title">Cloud</span> <span class="title">Gateway</span> <span class="title">distinguishes</span> <span class="title">between</span> “<span class="title">pre</span>” <span class="title">and</span> “<span class="title">post</span>” <span class="title">phases</span> <span class="title">for</span> <span class="title">filter</span> <span class="title">logic</span> <span class="title">execution</span> (<span class="title">see</span> <span class="title">How</span> <span class="title">it</span> <span class="title">Works</span>), <span class="title">the</span> <span class="title">filter</span> <span class="title">with</span> <span class="title">the</span> <span class="title">highest</span> <span class="title">precedence</span> <span class="title">is</span> <span class="title">the</span> <span class="title">first</span> <span class="title">in</span> <span class="title">the</span> “<span class="title">pre</span>”-<span class="title">phase</span> <span class="title">and</span> <span class="title">the</span> <span class="title">last</span> <span class="title">in</span> <span class="title">the</span> “<span class="title">post</span>”-<span class="title">phase</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line">The following listing configures a filter chain:</span><br><span class="line"></span><br><span class="line">Example <span class="number">56</span>. ExampleConfiguration.java</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">customFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CustomGlobalFilter();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomGlobalFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"custom global filter"</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>实现接口GlobalFilter, Ordered</li>
<li>注意，此处就是一个责任链的设计模式</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.bli.guigu.springcloud.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.ZonedDateTime;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: springcloud2020</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mk_passby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-08-04 21:55</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLogGateWayFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"***********come in :"</span> + ZonedDateTime.now());</span><br><span class="line">        String uname = exchange.getRequest().getQueryParams().getFirst(<span class="string">"uname"</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(uname)) &#123;</span><br><span class="line">            log.info(<span class="string">"用户名为null，非法用户"</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="SpringCloud-config分布式配置中心"><a href="#SpringCloud-config分布式配置中心" class="headerlink" title="SpringCloud config分布式配置中心"></a>SpringCloud config分布式配置中心</h1><ul>
<li><p>解决分布式系统中配置散乱的不好维护的问题，统一由配置中心管理，所有的应用都从配置中心去获取参数设置</p>
</li>
<li><p>官网<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/" target="_blank" rel="noopener">https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.1.RELEASE/reference/html/</a></p>
</li>
<li><p>作用</p>
<ul>
<li>集中管理配置文件</li>
<li>不同环境不同配置，动态化的配置更新，分环境部署比如dev/test/prod/beta/release</li>
<li>运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，服务会向配置中心统一拉取配置自己的信息</li>
<li>当配置发生变动时，服务不需要重启即可感知到配置的变化并应用新的配置</li>
<li>将配置信息以REST接口的形式暴露，post、curl访问刷新均可….</li>
</ul>
</li>
<li><p>配置文件修改后，需要运维人员发送Post请求刷新3355(curl -X POST “<a href="http://localhost:3355/actuator/refresh&quot;)，但是每次刷新的都是一个configClient，如果有一万台configClient，那运维不得疯？怎么处理呢？详见CommandBus的使用" target="_blank" rel="noopener">http://localhost:3355/actuator/refresh&quot;)，但是每次刷新的都是一个configClient，如果有一万台configClient，那运维不得疯？怎么处理呢？详见CommandBus的使用</a></p>
</li>
</ul>
<h3 id="configServer的构建"><a href="#configServer的构建" class="headerlink" title="configServer的构建"></a>configServer的构建</h3><ul>
<li>pom</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="code">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">    &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="code">    &lt;dependency&gt;</span></span><br><span class="line"><span class="code">          &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">          &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">      &lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>改yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">3344</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-config-center</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span>  <span class="attr">https://github.com/mk-passby/sprincloud-config.git</span> <span class="comment">#填写你自己的github路径</span></span><br><span class="line">          <span class="comment"># 搜索路径</span></span><br><span class="line"><span class="attr">          search-paths:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">springcloud-config</span></span><br><span class="line">      <span class="comment"># 读取分支</span></span><br><span class="line"><span class="attr">      label:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span>  <span class="attr">http://localhost:7001/eureka</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">5672</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">'bus-refresh'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bli.guigu.springcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.config.server.EnableConfigServer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: springcloud2020</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 配置中心3344</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mk_passby</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-08-04 22:48</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigCenterMain3344</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigCenterMain3344.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="configClient的构建"><a href="#configClient的构建" class="headerlink" title="configClient的构建"></a>configClient的构建</h3><ul>
<li>pom</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="code">     &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">     &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</span></span><br><span class="line">   <span class="xml"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="code">     &lt;dependency&gt;</span></span><br><span class="line"><span class="code">           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">           &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">       &lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>yarm</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">3355</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">config-client</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      label:</span> <span class="string">master</span> <span class="comment">#分支名称</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">config</span> <span class="comment">#配置文件名称</span></span><br><span class="line"><span class="attr">      profile:</span> <span class="string">dev</span> <span class="comment">#读取后缀名称，读取http://config-3344.com:3344/master/config-dev.yml</span></span><br><span class="line"><span class="attr">      uri:</span> <span class="attr">http://localhost:3344</span> <span class="comment">#配置中心地址</span></span><br><span class="line"><span class="attr">  rabbitmq:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">5672</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://eureka7001.com:7001/eureka</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientMain3355</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">            SpringApplication.run( ConfigClientMain3355.class,args);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>业务类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springcloud.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@RestController</span><span class="comment">//自动刷新</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;config.info&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/configInfo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConfigInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="SpringCloud-Bus-消息总线"><a href="#SpringCloud-Bus-消息总线" class="headerlink" title="SpringCloud Bus 消息总线"></a>SpringCloud Bus 消息总线</h1><ul>
<li>Spring Cloud Bus配合Spring Cloud Config使用可以实现配置的动态刷新<br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/39.bmp" alt=""></li>
<li>Bus支持两种消息代理：RabbitMQ和Kafka</li>
<li>SpringCloudBus可以管理和传播分布式系统之间的消息，可用于广播状态更新，事件推送等，也可以作为微服务之前的通讯通道</li>
<li><p>为什么称为总线：<img src="/2020/08/23/框架系列/springcloud/springcloud总结/40.bmp"></p>
</li>
<li><p>一次修改，广播通知，处处生效</p>
</li>
</ul>
<h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><ul>
<li>pom</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="code">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">            &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">3355</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">config-client</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      label:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">      profile:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">      uri:</span> <span class="attr">http://localhost:3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  rabbitmq:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">5672</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://eureka7001.com:7001/eureka</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  endpoints:</span></span><br><span class="line"><span class="attr">    web:</span></span><br><span class="line"><span class="attr">      exposure:</span></span><br><span class="line"><span class="attr">        include:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
<h2 id="通知总结"><a href="#通知总结" class="headerlink" title="通知总结"></a>通知总结</h2><p><img src="/2020/08/23/框架系列/springcloud/springcloud总结/41.bmp" alt=""><br><img src="/2020/08/23/框架系列/springcloud/springcloud总结/42.bmp" alt=""></p>
<ul>
<li>利用消息总线触发一个服务端ConfigServer的/bus/refresh端点,而刷新所有客户端的配置</li>
</ul>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/mk-passby">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    <script>
        /**
         *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
         *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        if( '' || '')
        var disqus_config = function () {
            this.page.url = '';  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://airclouds-blog.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>



</html>
