<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="mk-passby的博客">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        分布式基础 - mk-passby的博客 | mk-passby&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 我想回头望  把故事从头讲~ </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>mk-passby</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#分布式系统"><span class="toc-text">分布式系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAP理论"><span class="toc-text">CAP理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CAP-的取舍"><span class="toc-text">CAP 的取舍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CP架构"><span class="toc-text">CP架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AP架构"><span class="toc-text">AP架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#思考"><span class="toc-text">思考</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Base-理论"><span class="toc-text">Base 理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本可用（Basically-Available）"><span class="toc-text">基本可用（Basically Available）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#软状态（Soft-State）"><span class="toc-text">软状态（Soft State）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#最终一致性（Eventually-Consistent）"><span class="toc-text">最终一致性（Eventually Consistent）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Paxos-算法"><span class="toc-text">Paxos 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Quorum-选举算法"><span class="toc-text">Quorum 选举算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Quorum-的应用"><span class="toc-text">Quorum 的应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Paxos-的节点角色"><span class="toc-text">Paxos 的节点角色</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Proposer提案者"><span class="toc-text">Proposer提案者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Acceptor"><span class="toc-text">Acceptor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Learner"><span class="toc-text">Learner</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Paxos-选举过程"><span class="toc-text">Paxos 选举过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Phase-1-准备阶段"><span class="toc-text">Phase 1 准备阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Phase-2-选举阶段"><span class="toc-text">Phase 2 选举阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Proposer-发送-Accept"><span class="toc-text">Proposer 发送 Accept</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Acceptor-应答-Accept"><span class="toc-text">Acceptor 应答 Accept</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Proposer-统计投票"><span class="toc-text">Proposer 统计投票</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZooKeeper-是如何实现数据一致性"><span class="toc-text">ZooKeeper 是如何实现数据一致性</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i> 我想回头望  把故事从头讲~ </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        分布式基础
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2020-10-20 18:40:16</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#分布式" title="分布式">分布式</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2 id="分布式系统"><a href="#分布式系统" class="headerlink" title="分布式系统"></a>分布式系统</h2><ul>
<li><p>分布式系统技术就是用来解决集中式架构的性能瓶颈问题，来适应快速发展的业务规模。</p>
</li>
<li><p>为了应对高并发访问，和大量数据处理的任务，我们需要系统做到</p>
<ul>
<li>可扩展</li>
<li>不出现单点故障</li>
</ul>
</li>
</ul>
<h2 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h2><p>CAP 理论：一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容忍性（Partition Tolerance）这三项中的两项。</p>
<table>
<thead>
<tr>
<th>CAP</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>一致性（Consistency）</td>
<td>所有节点在同一时间的数据完全一致</td>
</tr>
<tr>
<td>可用性（Availability）</td>
<td>服务一直可用，而且是正常响应时间</td>
</tr>
<tr>
<td>分区容忍性（Partition Tolerance）</td>
<td>当部分节点出现消息丢失或者分区故障的时候，分布式系统仍然能够继续运行</td>
</tr>
</tbody>
</table>
<h3 id="CAP-的取舍"><a href="#CAP-的取舍" class="headerlink" title="CAP 的取舍"></a>CAP 的取舍</h3><p>CAP 理论说明，在架构设计中，不要考虑设计能满足三者的完美分布式系统上，而要合理进行取舍，CAP 理论只能三者选其二，不能全部获得</p>
<h4 id="CP架构"><a href="#CP架构" class="headerlink" title="CP架构"></a>CP架构</h4><ul>
<li>放弃可用性，追求一致性和分区容错性。最典型的就是zookeeper。核心算法Zab，所有设计都是为了一致性</li>
</ul>
<h4 id="AP架构"><a href="#AP架构" class="headerlink" title="AP架构"></a>AP架构</h4><ul>
<li>对于 AP 来说，放弃强一致性，追求分区容错性和可用性。典型例子，为eureka注册中心。</li>
</ul>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>1.为什么CAP理论中，最多只能只能满足其中两项？</p>
<p>2.Nacos为什么即可以支持AP和CP的切换(不是同时满足)呢?</p>
<h2 id="Base-理论"><a href="#Base-理论" class="headerlink" title="Base 理论"></a>Base 理论</h2><p>Base 是三个短语的简写，即基本可用（Basically Available）、软状态（Soft State）和最终一致性（Eventually Consistent）。</p>
<p>即无法做到强一致性，那么采用某种方式达到最终一致性。</p>
<p>Base 理论的核心思想是<strong>最终一致性</strong>，</p>
<h3 id="基本可用（Basically-Available）"><a href="#基本可用（Basically-Available）" class="headerlink" title="基本可用（Basically Available）"></a>基本可用（Basically Available）</h3><ul>
<li>系统能够基本运行，能一直提供服务。允许损失部分可用性，相比正常的系统，可能是响应时间延长，或者是服务被降级</li>
</ul>
<h3 id="软状态（Soft-State）"><a href="#软状态（Soft-State）" class="headerlink" title="软状态（Soft State）"></a>软状态（Soft State）</h3><ul>
<li>软状态则是允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时</li>
</ul>
<h3 id="最终一致性（Eventually-Consistent）"><a href="#最终一致性（Eventually-Consistent）" class="headerlink" title="最终一致性（Eventually Consistent）"></a>最终一致性（Eventually Consistent）</h3><ul>
<li>数据不可能一直是软状态，必须在某一个时刻，达到各个节点的一致性。即达到了最终一致性</li>
</ul>
<h2 id="Paxos-算法"><a href="#Paxos-算法" class="headerlink" title="Paxos 算法"></a>Paxos 算法</h2><ul>
<li>在学习 Paxos 算法之前，我们先来看分布式系统中的 Quorum 选举算法</li>
</ul>
<h3 id="Quorum-选举算法"><a href="#Quorum-选举算法" class="headerlink" title="Quorum 选举算法"></a>Quorum 选举算法</h3><ul>
<li><p>在 N 个副本中，一次更新成功的如果有 W 个，那么我在读取数据时是要从大于 N－W 个副本中读取，这样就能至少读到一个更新的数据了</p>
</li>
<li><p>Quorum 的定义如下：假设有 N 个副本，更新操作 wi 在 W 个副本中更新成功之后，才认为此次更新操作 wi 成功，把这次成功提交的更新操作对应的数据叫做：“成功提交的数据”。对于读操作而言，至少需要读 R 个副本才能读到此次更新的数据，其中，W+R&gt;N ，即 W 和 R 有重叠，一般，W+R=N+1。</p>
<ul>
<li>N = 存储数据副本的数量</li>
<li>W = 更新成功所需的副本</li>
<li>R = 一次数据对象读取要访问的副本的数量</li>
</ul>
</li>
</ul>
<p>Quorum就是限定了一次需要读取至少N+1-w的副本数据,听起来有些抽象，举个例子，我们维护了10个副本，一次成功更新了三个，那么至少需要读取八个副本的数据，可以保证我们读到了最新的数据。</p>
<h3 id="Quorum-的应用"><a href="#Quorum-的应用" class="headerlink" title="Quorum 的应用"></a>Quorum 的应用</h3><ul>
<li><p>Quorum 机制<strong>无法保证强一致性</strong>，也就是无法实现任何时刻任何用户或节点都可以读到最近一次成功提交的副本数据。</p>
</li>
<li><p>Quorum 机制的使用需要配合一个获取最新成功提交的版本号的 metadata 服务，这样可以确定最新已经成功提交的版本号，然后从已经读到的数据中就可以确认最新写入的数据。</p>
</li>
<li><p>Quorum 是分布式系统中常用的一种机制，用来保证数据冗余和最终一致性的投票算法，在 Paxos、Raft 和 ZooKeeper 的 Zab 等算法中，都可以看到 Quorum 机制的应用。</p>
</li>
</ul>
<h3 id="Paxos-的节点角色"><a href="#Paxos-的节点角色" class="headerlink" title="Paxos 的节点角色"></a>Paxos 的节点角色</h3><h4 id="Proposer提案者"><a href="#Proposer提案者" class="headerlink" title="Proposer提案者"></a>Proposer提案者</h4><ul>
<li><p>Proposer 可以有多个，在流程开始时，Proposer 提出议案，也就是value，所谓 value，在工程中可以是任何操作，比如“修改某个变量的值为某个新值”，Paxos 协议中统一将这些操作抽象为 value。</p>
</li>
<li><p>不同的 Proposer 可以提出不同的甚至矛盾的 value，比如某个 Proposer 提议“将变量 X 设置为 1”，另一个 Proposer 提议“将变量 X 设置为 2”，但对同一轮 Paxos 过程，最多只有一个 value 被批准。</p>
</li>
</ul>
<h4 id="Acceptor"><a href="#Acceptor" class="headerlink" title="Acceptor"></a>Acceptor</h4><ul>
<li>在集群中，Acceptor 有 N 个，Acceptor 之间完全对等独立，Proposer 提出的 value 必须获得超过半数（N/2+1）的 Acceptor 批准后才能通过</li>
</ul>
<h4 id="Learner"><a href="#Learner" class="headerlink" title="Learner"></a>Learner</h4><ul>
<li><p>Learner 不参与选举，而是学习被批准的 value，在Paxos中，Learner主要参与相关的状态机同步流程。</p>
<p>这里Leaner的流程就参考了Quorum 议会机制，某个 value 需要获得 W=N/2 + 1 的 Acceptor 批准，Learner 需要至少读取 N/2+1 个 Accpetor，最多读取 N 个 Acceptor 的结果后，才能学习到一个通过的 value。</p>
</li>
</ul>
<h3 id="Paxos-选举过程"><a href="#Paxos-选举过程" class="headerlink" title="Paxos 选举过程"></a>Paxos 选举过程</h3><p><img src="/2020/10/20/分布式/分布式基础/proxy选举过程.png" alt=""></p>
<h4 id="Phase-1-准备阶段"><a href="#Phase-1-准备阶段" class="headerlink" title="Phase 1 准备阶段"></a>Phase 1 准备阶段</h4><ul>
<li><p>Proposer 生成全局唯一且递增的 ProposalID，向 Paxos 集群的所有机器发送 Prepare 请求</p>
</li>
<li><p>Acceptor 收到 Prepare 请求后，判断收到的 ProposalID 是否比之前已响应的所有提案的 N 大，如果是，则：</p>
<ul>
<li>在本地持久化 ProposalID，可记为 Max_ProposalID；</li>
<li>回复请求，并带上已经 Accept 的提案中 ProposalID 最大的 value，如果此时还没有已经 Accept 的提案，则返回 value 为空；</li>
<li>做出承诺，不会 Accept 任何小于 Max_N 的提案。</li>
</ul>
</li>
</ul>
<p>​        如果否，则不回复或者回复 Error。</p>
<h4 id="Phase-2-选举阶段"><a href="#Phase-2-选举阶段" class="headerlink" title="Phase 2 选举阶段"></a>Phase 2 选举阶段</h4><h5 id="Proposer-发送-Accept"><a href="#Proposer-发送-Accept" class="headerlink" title="Proposer 发送 Accept"></a>Proposer 发送 Accept</h5><ul>
<li>经过一段时间后，Proposer 收集到一些 Acceptor回复，有下列几种情况：<ul>
<li>若回复数量 &gt; 一半的 Acceptor 数量，且所有回复的 value 都为空时，则 Porposer 发出 accept 请求，并带上自己指定的 value。</li>
<li>若回复数量 &gt; 一半的 Acceptor 数量，且有的回复 value 不为空时，则 Porposer 发出 accept 请求，并带上回复中 ProposalID 最大的 value，作为自己的提案内容。</li>
<li>若回复数量 &lt;= 一半的 Acceptor 数量时，则尝试更新生成更大的 ProposalID，再转到准备阶段执行。</li>
</ul>
</li>
</ul>
<h5 id="Acceptor-应答-Accept"><a href="#Acceptor-应答-Accept" class="headerlink" title="Acceptor 应答 Accept"></a>Acceptor 应答 Accept</h5><ul>
<li>Accpetor 收到 Accpet 请求 后，判断：<ul>
<li>若收到的 ProposalID &gt;= Max_ProposalID（一般情况下是等于），则回复提交成功，并持久化ProposalID 和 value；</li>
<li>若收到的 N &lt; Max_N，则不回复或者回复提交失败。</li>
</ul>
</li>
</ul>
<h5 id="Proposer-统计投票"><a href="#Proposer-统计投票" class="headerlink" title="Proposer 统计投票"></a>Proposer 统计投票</h5><ul>
<li>经过一段时间后，Proposer 会收集到一些 Accept 回复提交成功的情况，比如：<ul>
<li>当回复数量 &gt; 一半的 Acceptor 数量时，则表示提交 value 成功，此时可以发一个广播给所有的 Proposer、Learner，通知它们已 commit 的 value；</li>
<li>当回复数量 &lt;= 一半的 Acceptor 数量时，则尝试更新生成更大的 ProposalID，转到准备阶段执行。</li>
<li>当收到一条提交失败的回复时，则尝试更新生成更大的 ProposalID，也会转到准备阶段执行。</li>
</ul>
</li>
</ul>
<h3 id="ZooKeeper-是如何实现数据一致性"><a href="#ZooKeeper-是如何实现数据一致性" class="headerlink" title="ZooKeeper 是如何实现数据一致性"></a>ZooKeeper 是如何实现数据一致性</h3>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/mk-passby">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    <script>
        /**
         *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
         *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        if( '' || '')
        var disqus_config = function () {
            this.page.url = '';  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://airclouds-blog.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>



</html>
